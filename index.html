<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meu Universo X — Seguro (AES-GCM)</title>

<!-- Dependências CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{--bg:#071021;--accent:#8b5cf6}
  html,body,#app{height:100%}
  body{margin:0;font-family:Inter,system-ui; background:linear-gradient(180deg,#071021,#041226); color:#eaf2ff}
  .handwriting{font-family:'Caveat',cursive}
  .btn { background:linear-gradient(90deg,var(--accent),#ec4899); color:white; padding:.5rem .9rem; border-radius:8px; }
  .ghost{opacity:.06}
  .postit{border-radius:10px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; background:rgba(1,4,10,0.6) }
  .card { background:linear-gradient(145deg,#fff9e6,#fef5d4); color:#071021; padding:16px; border-radius:10px; box-shadow:0 20px 50px rgba(0,0,0,0.6)}
  input,textarea{font-family:inherit}
  .small{font-size:12px;color:rgba(0,0,0,0.6)}
</style>
</head>
<body>
<div id="app" class="h-screen grid grid-rows-[auto_1fr]">
  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-3 border-b border-white/6">
    <div class="flex items-center gap-3">
      <img id="logo" src='/mnt/data/A_composite_digital_screenshot_of_"Meu_Universo_X,.png' alt="macaco" class="w-10 h-10 rounded-md object-cover" onerror="this.style.display='none'">
      <div>
        <div class="font-semibold text-lg">Meu Universo X — Seguro</div>
        <div class="text-xs opacity-70">Notas encriptadas localmente (AES-GCM-256)</div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <input id="search" placeholder="Procurar..." class="bg-transparent border border-white/6 px-3 py-2 rounded-md" />
      <button id="btn-new" class="btn">+ Nova</button>
      <button id="btn-export" class="px-3 py-2 rounded border border-white/8">Export encriptado</button>
      <button id="btn-import" class="px-3 py-2 rounded border border-white/8">Importar backup</button>
    </div>
  </header>

  <!-- Main -->
  <main class="p-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
    <section class="lg:col-span-2 relative" id="viz-area">
      <canvas id="canvas3d" class="w-full h-96 bg-transparent"></canvas>
      <div class="mt-4 grid grid-cols-3 gap-3" id="grid"></div>
    </section>

    <aside>
      <div class="card">
        <h3 class="font-semibold">Controle</h3>
        <p class="small mt-2">Estado: <span id="lock-status">Bloqueado</span></p>
        <div class="mt-4">
          <button id="btn-lock" class="px-3 py-2 rounded border">Bloquear</button>
          <button id="btn-change-pass" class="px-3 py-2 rounded border">Mudar Password</button>
        </div>
        <div class="mt-4">
          <label class="small">Auto-lock (min)</label>
          <input id="auto-lock" type="number" value="5" min="1" class="w-full mt-1 p-2 rounded border small"/>
        </div>
        <div class="mt-4 small">Backups encriptados são seguros — guarda fora do navegador.</div>
      </div>

      <div class="card mt-4">
        <h4 class="font-semibold">Ajuda rápida</h4>
        <ul class="small mt-2">
          <li>✅ A password nunca é enviada — só usada para derivar a chave.</li>
          <li>✅ Backup exportado contém salt+iv+ciphertext.</li>
          <li>⚠️ Se perderes a password, não há recuperação.</li>
        </ul>
      </div>
    </aside>
  </main>
</div>

<!-- MODAIS -->
<div id="modal-lock" class="modal" style="display:block">
  <div class="card w-full max-w-md">
    <h3 class="handwriting text-2xl">Meu Universo X — Acesso Seguro</h3>
    <p class="small mt-1">Insere a tua password mestra para desbloquear as notas.</p>

    <div id="first-setup" style="display:none">
      <p class="mt-3 small">Parece que é a primeira utilização. Cria uma password forte (memorizá-la).</p>
      <input id="new-pass" type="password" placeholder="Nova password" class="w-full mt-2 p-2 rounded border"/>
      <input id="new-pass-confirm" type="password" placeholder="Confirmar password" class="w-full mt-2 p-2 rounded border"/>
      <div class="flex gap-2 mt-3">
        <button id="setup-btn" class="btn">Criar password</button>
      </div>
    </div>

    <div id="login-area" style="display:none">
      <input id="master-pass" type="password" placeholder="Password" class="w-full mt-3 p-2 rounded border"/>
      <div class="flex gap-2 mt-3">
        <button id="unlock-btn" class="btn">Desbloquear</button>
      </div>
      <p class="small mt-2">Se não lembrares a password, não há recuperação — por design.</p>
    </div>
  </div>
</div>

<!-- EDITOR (modal simples) -->
<div id="modal-editor" class="modal" style="display:none">
  <div class="card max-w-3xl w-full">
    <div class="flex justify-between items-start">
      <div>
        <input id="edit-title" placeholder="Título" class="w-full p-2 rounded border" />
        <textarea id="edit-body" rows="8" class="w-full mt-2 p-3 rounded border" placeholder="Escreve... usa #tags e [[Wikilinks]]"></textarea>
      </div>
      <div style="width:220px;margin-left:12px">
        <label class="small">Cor</label>
        <input id="edit-color" type="color" value="#fff1cc" class="w-full mt-2 p-2 rounded border"/>
        <div class="mt-3 flex gap-2">
          <button id="save-note" class="btn">Salvar</button>
          <button id="close-editor" class="px-3 py-2 rounded border">Fechar</button>
        </div>
        <div class="mt-3">
          <button id="del-note" class="px-3 py-2 rounded border">Excluir</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================================
   Segurança criptográfica - AES-GCM via WebCrypto
   Design:
   - password -> PBKDF2(salt) -> key (AES-GCM-256)
   - salt salvo em localStorage (não sensível por si só)
   - dados salvos em localStorage sob chave 'mux_cipher'
   - export contém {salt, iv, data} em base64 JSON
   - on first use: cria salt e pede password inicial
   - timeout: auto-lock após X minutos (configurável)
   ============================================*/

const STORAGE_SALT = 'mux_salt_v1';
const STORAGE_CIPHER = 'mux_cipher_v1';
const STORAGE_META = 'mux_meta_v1'; // metadata optional
let masterKey = null; // CryptoKey
let unlocked = false;
let notes = []; // in-memory decrypted notes
let autoLockMinutes = 5;
let autoLockTimer = null;
let lastActivity = Date.now();

/* ---------- helpers Base64 ---------- */
function bufToB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b64ToBuf(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }

/* ---------- derivation: PBKDF2 ---------- */
async function deriveKeyFromPassword(password, saltBase64){
  const enc = new TextEncoder();
  const pwKey = await window.crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const salt = b64ToBuf(saltBase64);
  const key = await window.crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:250000, hash:'SHA-256'},
    pwKey,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
  return key;
}

/* ---------- random salt/iv ---------- */
function randomBytes(n){ const arr = new Uint8Array(n); crypto.getRandomValues(arr); return arr.buffer; }
function generateSalt(){ return bufToB64(randomBytes(16)); }
function generateIV(){ return bufToB64(randomBytes(12)); }

/* ---------- encrypt/decrypt ---------- */
async function encryptNotesWithKey(key, plainObj){
  const ivB64 = generateIV();
  const enc = new TextEncoder();
  const raw = enc.encode(JSON.stringify(plainObj));
  const ciphertext = await crypto.subtle.encrypt({name:'AES-GCM', iv: b64ToBuf(ivB64)}, key, raw);
  return { iv: ivB64, data: bufToB64(ciphertext) };
}

async function decryptNotesWithKey(key, ivB64, dataB64){
  try{
    const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv: b64ToBuf(ivB64)}, key, b64ToBuf(dataB64));
    const dec = new TextDecoder().decode(pt);
    return JSON.parse(dec);
  }catch(e){
    throw new Error('Desencriptação falhou — password errada ou dados corrompidos.');
  }
}

/* ---------- storage helpers ---------- */
function saveCipherToStorage(saltB64, ivB64, dataB64){
  const payload = { salt: saltB64, iv: ivB64, data: dataB64, timestamp: Date.now() };
  localStorage.setItem(STORAGE_CIPHER, JSON.stringify(payload));
}
function loadCipherFromStorage(){ const raw = localStorage.getItem(STORAGE_CIPHER); return raw ? JSON.parse(raw) : null; }
function saveSalt(saltB64){ localStorage.setItem(STORAGE_SALT, saltB64); }
function loadSalt(){ return localStorage.getItem(STORAGE_SALT); }

/* ---------- high-level flows ---------- */
async function initialSetup(password){
  const salt = generateSalt();
  saveSalt(salt);
  const key = await deriveKeyFromPassword(password, salt);
  // start with empty notes
  const enc = await encryptNotesWithKey(key, []);
  saveCipherToStorage(salt, enc.iv, enc.data);
  masterKey = key; unlocked=true;
  notes = [];
  onUnlocked();
}

async function unlockWithPassword(password){
  const salt = loadSalt();
  if(!salt) throw new Error('Sem configuração inicial. Cria uma password primeiro.');
  const key = await deriveKeyFromPassword(password, salt);
  const cipher = loadCipherFromStorage();
  if(!cipher) { masterKey = key; unlocked=true; notes=[]; onUnlocked(); return; }
  const pt = await decryptNotesWithKey(key, cipher.iv, cipher.data);
  masterKey = key; unlocked=true; notes = pt || [];
  onUnlocked();
}

async function saveNotesEncrypted(){
  if(!masterKey) throw new Error('Sem chave ativa');
  const enc = await encryptNotesWithKey(masterKey, notes);
  // salt already present in storage
  const salt = loadSalt();
  saveCipherToStorage(salt, enc.iv, enc.data);
}

async function changePassword(oldPass, newPass){
  // derive old key to decrypt, then derive new key and re-encrypt with new salt
  const saltOld = loadSalt();
  const keyOld = await deriveKeyFromPassword(oldPass, saltOld);
  const cipher = loadCipherFromStorage();
  const pt = cipher ? await decryptNotesWithKey(keyOld, cipher.iv, cipher.data) : [];
  // now create new salt/key and store
  const saltNew = generateSalt();
  saveSalt(saltNew);
  const keyNew = await deriveKeyFromPassword(newPass, saltNew);
  const enc = await encryptNotesWithKey(keyNew, pt);
  saveCipherToStorage(saltNew, enc.iv, enc.data);
  masterKey = keyNew; notes = pt; unlocked=true; onUnlocked();
}

/* ---------- export / import ---------- */
function exportEncryptedBackup(){
  const cipher = loadCipherFromStorage();
  if(!cipher) return alert('Sem dados para exportar');
  const meta = { app:'Meu Universo X', version:'mux-v1' };
  const out = { meta, payload: cipher };
  const blob = new Blob([JSON.stringify(out)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'meu_universo_x_backup_muxbak.json'; a.click();
}

function importEncryptedBackup(file){
  const fr = new FileReader();
  fr.onload = (e)=>{
    try{
      const parsed = JSON.parse(e.target.result);
      if(!parsed || !parsed.payload || !parsed.payload.salt) return alert('Backup inválido');
      // store payload as-is (will require the correct password to decrypt later)
      localStorage.setItem(STORAGE_CIPHER, JSON.stringify(parsed.payload));
      localStorage.setItem(STORAGE_SALT, parsed.payload.salt);
      alert('Backup importado. Agora desbloqueia com a tua password para desencriptar.');
      location.reload();
    }catch(err){ alert('Falha ao importar: '+err.message) }
  };
  fr.readAsText(file);
}

/* ---------- locking behavior ---------- */
function lockNow(){
  masterKey = null; unlocked=false; notes=[]; clearTimeout(autoLockTimer);
  document.getElementById('modal-lock').style.display = 'flex';
  document.getElementById('lock-status').innerText = 'Bloqueado';
}

function scheduleAutoLock(){
  clearTimeout(autoLockTimer);
  const mins = Number(document.getElementById('auto-lock').value) || autoLockMinutes;
  autoLockTimer = setTimeout(()=>{ lockNow(); alert('Sessão bloqueada por inatividade.'); }, mins*60*1000);
  document.getElementById('lock-status').innerText = 'Desbloqueado (auto-lock em '+mins+' min)';
}

/* ---------- UI wiring & note model ---------- */
function renderGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  notes.slice().reverse().forEach(n=>{
    const el = document.createElement('div');
    el.className = 'postit';
    el.style.background = n.color || '#fff9e6';
    el.innerHTML = `
      <div style="padding:10px; width:100%; border-radius:8px">
        <div style="font-weight:600">${escapeHtml(n.title || 'Sem título')}</div>
        <div style="margin-top:6px;color:#111;opacity:0.86">${escapeHtml(truncate(n.body || '', 140))}</div>
        <div style="margin-top:10px;display:flex;gap:6px;justify-content:flex-end">
          <button class="open" data-id="${n.id}" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">Abrir</button>
        </div>
      </div>`;
    el.querySelector('.open').addEventListener('click', ()=> openEditor(n.id));
    grid.appendChild(el);
  });
}

/* tiny helpers */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function truncate(s,l){ return s.length>l? s.slice(0,l-1)+'...':s; }
function uid(){ return 'n_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8) }

/* Editor flow */
function openEditor(id){
  if(!unlocked) return alert('Desbloqueia primeiro');
  const modal = document.getElementById('modal-editor');
  modal.style.display='flex';
  const title = document.getElementById('edit-title');
  const body = document.getElementById('edit-body');
  const color = document.getElementById('edit-color');
  if(id){
    const n = notes.find(x=>x.id===id);
    title.value = n.title || '';
    body.value = n.body || '';
    color.value = n.color || '#fff1cc';
    modal.dataset.editId = id;
  }else{
    title.value=''; body.value=''; color.value='#fff1cc'; modal.dataset.editId = '';
  }
}

/* save from editor */
document.getElementById('save-note').addEventListener('click', async ()=>{
  const id = document.getElementById('modal-editor').dataset.editId;
  const t = document.getElementById('edit-title').value.trim();
  const b = document.getElementById('edit-body').value.trim();
  const c = document.getElementById('edit-color').value;
  if(id){
    const n = notes.find(x=>x.id===id);
    n.title = t; n.body = b; n.color = c; n.updatedAt = Date.now();
  }else{
    notes.push({ id: uid(), title: t, body: b, color: c, createdAt: Date.now(), updatedAt: Date.now() });
  }
  await saveNotesEncrypted();
  document.getElementById('modal-editor').style.display='none';
  renderGrid();
  scheduleAutoLock();
});

/* new note */
document.getElementById('btn-new').addEventListener('click', ()=> openEditor(null));
document.getElementById('close-editor').addEventListener('click', ()=> document.getElementById('modal-editor').style.display='none');

/* delete note */
document.getElementById('del-note').addEventListener('click', async ()=>{
  const id = document.getElementById('modal-editor').dataset.editId;
  if(!id) return alert('Nota não guardada ainda');
  if(!confirm('Confirmar exclusão?')) return;
  notes = notes.filter(x=>x.id!==id);
  await saveNotesEncrypted();
  document.getElementById('modal-editor').style.display='none';
  renderGrid();
});

/* unlock modal wiring */
document.getElementById('unlock-btn').addEventListener('click', async ()=>{
  const pass = document.getElementById('master-pass').value;
  if(!pass) return alert('Insere a password');
  try{
    await unlockWithPassword(pass);
  }catch(err){ alert(err.message); return; }
  document.getElementById('modal-lock').style.display='none';
});

/* first setup */
document.getElementById('setup-btn').addEventListener('click', async ()=>{
  const p1 = document.getElementById('new-pass').value;
  const p2 = document.getElementById('new-pass-confirm').value;
  if(!p1 || p1.length < 8) return alert('Password mínima: 8 caracteres');
  if(p1 !== p2) return alert('Passwords não coincidem');
  await initialSetup(p1);
  document.getElementById('modal-lock').style.display='none';
});

/* lock button */
document.getElementById('btn-lock').addEventListener('click', ()=> lockNow());

/* change password UI */
document.getElementById('btn-change-pass').addEventListener('click', async ()=>{
  if(!unlocked) return alert('Desbloqueia primeiro');
  const oldP = prompt('Password actual:');
  if(!oldP) return;
  const newP = prompt('Nova password (mín 8 chars):');
  if(!newP || newP.length<8) return alert('Password inválida');
  try{
    await changePassword(oldP, newP);
    alert('Password alterada com sucesso.');
    scheduleAutoLock();
  }catch(err){ alert('Não foi possível mudar password: '+err.message) }
});

/* export/import */
document.getElementById('btn-export').addEventListener('click', ()=> exportEncryptedBackup());
document.getElementById('btn-import').addEventListener('click', ()=>{
  const f = document.createElement('input'); f.type='file'; f.accept='application/json';
  f.onchange = e => { if(e.target.files[0]) importEncryptedBackup(e.target.files[0]); };
  f.click();
});

/* search */
document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  const cards = document.querySelectorAll('#grid > div');
  cards.forEach(card=>{
    card.style.display = !q ? 'block' : (card.innerText.toLowerCase().includes(q) ? 'block' : 'none');
  });
});

/* auto-lock config */
document.getElementById('auto-lock').addEventListener('change', ()=> scheduleAutoLock());

/* activity resets auto-lock */
['mousemove','keydown','click','touchstart'].forEach(ev=>{
  window.addEventListener(ev, ()=> { lastActivity = Date.now(); if(unlocked) scheduleAutoLock(); });
});

/* ---------- boot sequence ---------- */
(async function boot(){
  // if no salt present => first time
  const salt = localStorage.getItem(STORAGE_SALT);
  if(!salt){
    document.getElementById('first-setup').style.display='block';
    document.getElementById('login-area').style.display='none';
    document.getElementById('lock-status').innerText='Configuração inicial';
    return;
  }else{
    // show login area
    document.getElementById('first-setup').style.display='none';
    document.getElementById('login-area').style.display='block';
    document.getElementById('master-pass').focus();
  }
})();

/* ---------- after unlock UI updates ---------- */
function onUnlocked(){
  document.getElementById('lock-status').innerText='Desbloqueado';
  document.getElementById('modal-lock').style.display='none';
  renderGrid();
  scheduleAutoLock();
}

/* ---------- small 3D graph (visual only) ---------- */
(function initThree(){
  const canvas = document.getElementById('canvas3d');
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
  renderer.setSize(canvas.clientWidth || canvas.width, 360);
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, (canvas.clientWidth||600)/360, 0.1, 2000); camera.position.set(0,0,120);
  scene.add(new THREE.AmbientLight(0xffffff,0.9));
  const geo = new THREE.BufferGeometry();
  const pts = 200; const arr = new Float32Array(pts*3);
  for(let i=0;i<pts;i++){ arr[i*3]= (Math.random()-0.5)*200; arr[i*3+1]=(Math.random()-0.5)*80; arr[i*3+2]=(Math.random()-0.5)*200; }
  geo.setAttribute('position', new THREE.BufferAttribute(arr,3));
  const points = new THREE.Points(geo, new THREE.PointsMaterial({size:1.8,color:0x8b5cf6,opacity:0.06,transparent:true}));
  scene.add(points);
  (function anim(){ requestAnimationFrame(anim); points.rotation.y += 0.0008; renderer.render(scene,camera); })();
})();

/* ---------- small utility: load decrypted from storage if unlocked already (edge case) ---------- */
(async function tryAutoUnlockIfSessionActive(){
  // If user used site earlier in same tab and key exists in memory, do nothing.
  // Otherwise, we wait user to provide password.
})();

</script>
</body>
</html>
