<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meu Universo X ‚Äî Shinobi Tech</title>

<!-- ====== ESTILOS ====== -->
<style>
  :root{
    --bg:#071022;
    --panel:#071026;
    --accent:#00d4ff;
    --muted:rgba(255,255,255,0.09);
    --glass: rgba(255,255,255,0.03);
    --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#fff;overflow:hidden}
  a{color:inherit}

  /* ---------- ANIMA√á√ÉO DO PERGAMINHO ---------- */
  #scroll-screen{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background: linear-gradient(180deg,#020417 0%, #07102a 60%);
    z-index:9999;
  }
  .scroll-wrap{width:92%;max-width:700px;transform-origin:top;animation:unroll 2.6s cubic-bezier(.2,.9,.3,1) forwards}
  @keyframes unroll{0%{transform:scaleY(0);opacity:0}60%{transform:scaleY(1.06);opacity:1}100%{transform:scaleY(1)}}
  .scroll-top,.scroll-bottom{height:48px;background:linear-gradient(90deg,#5a2f08,#a8652f,#5a2f08);border-radius:28px;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .scroll-paper{background:linear-gradient(180deg,#f2e5c8,#e6d4aa);padding:64px 36px;min-height:320px;text-align:center;box-shadow:inset 0 0 30px rgba(0,0,0,.12);position:relative;overflow:hidden}
  .seal{width:120px;height:120px;border-radius:50%;margin:0 auto 18px;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,#d93b3b,#7f0000);box-shadow:0 12px 30px rgba(217,59,59,.18);animation:spin 3.6s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .seal .char{font-size:44px;font-weight:800;letter-spacing:1px;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.6)}
  .title{font-family:Georgia,serif;font-size:42px;color:#7a451b;margin-top:6px;opacity:0;transform:translateY(18px);animation:titleIn 1.2s ease-out 1.4s forwards}
  @keyframes titleIn{to{opacity:1;transform:none}}
  .fade-out{animation:fadeOut 0.9s ease forwards}
  @keyframes fadeOut{to{opacity:0;visibility:hidden;transform:translateY(-8px)}}

  /* ---------- LOGIN ---------- */
  #login-screen{display:none;height:100vh;align-items:center;justify-content:center;padding:20px}
  .login-card{width:100%;max-width:420px;padding:28px;border-radius:12px;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border:1px solid var(--muted);backdrop-filter:blur(6px);box-shadow:0 20px 60px rgba(0,0,0,.6);text-align:center}
  .login-card h2{color:var(--accent);margin:0 0 12px;font-size:20px}
  .login-card p{margin:0 0 18px;color:rgba(255,255,255,.78);font-size:13px}
  .input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:#fff;margin-bottom:12px;outline:none}
  .btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#0099cc);color:#021;cursor:pointer;font-weight:700}
  .link{display:inline-block;margin-top:12px;color:rgba(255,255,255,.7);font-size:13px;cursor:pointer}
  .err{color:var(--danger);margin-top:8px;display:none;font-size:13px}

  /* ---------- APP PRINCIPAL ---------- */
  #app{display:none;height:100vh;overflow:hidden}
  .topbar{height:72px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:linear-gradient(90deg,rgba(0,0,0,.18),transparent);border-bottom:1px solid rgba(0,212,255,0.05)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46;border-radius:10px;background:linear-gradient(135deg,#021428,#002b42);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent);box-shadow:0 6px 24px rgba(0,212,255,.05)}
  .apptitle{font-size:18px;color:var(--accent);font-weight:700}
  .top-actions{display:flex;gap:10px;align-items:center}

  .container{display:flex;height:calc(100vh - 72px);overflow:hidden}
  .sidebar{width:260px;padding:22px;background:linear-gradient(180deg,rgba(0,0,0,0.12),rgba(0,0,0,0.02));border-right:1px solid rgba(255,255,255,0.02);backdrop-filter:blur(6px)}
  .side-section{margin-bottom:18px}
  .side-title{font-size:12px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
  .menu-item{padding:10px 12px;border-radius:8px;color:rgba(255,255,255,.8);cursor:pointer;margin-bottom:8px}
  .menu-item.active{background:linear-gradient(90deg,rgba(0,212,255,0.06),transparent);color:var(--accent);font-weight:700}

  .main{flex:1;padding:22px;overflow:auto;background:linear-gradient(180deg,#071026 0%, #041122 100%)}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  .search{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
  .note{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;min-height:110px;display:flex;flex-direction:column;gap:8px}
  .note h4{margin:0;font-size:15px;color:var(--accent)}
  .note p{margin:0;color:rgba(255,255,255,.78);font-size:13px;white-space:pre-wrap;flex:1}
  .note .meta{display:flex;justify-content:space-between;color:rgba(255,255,255,.45);font-size:12px}

  .floating{position:fixed;right:28px;bottom:28px;width:56px;height:56px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#0099cc);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021;box-shadow:0 12px 40px rgba(0,212,255,0.12);cursor:pointer}

  /* modal (editor/settings) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.6));z-index:1200}
  .modal-card{width:100%;max-width:720px;background:linear-gradient(180deg,#071026,#081430);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .row{display:flex;gap:12px}
  textarea.input{min-height:140px;resize:vertical;padding:12px}
  .small{font-size:13px;color:rgba(255,255,255,.7)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
  .note-meta {display:flex;gap:8px;align-items:center;margin-top:8px;color:rgba(255,255,255,.6)}

  @media(max-width:860px){
    .sidebar{display:none}
    .grid{grid-template-columns:1fr}
  }

  /* pequenas melhorias visuais */
  ::selection{background:rgba(0,212,255,0.12)}
  textarea, input{font-family:inherit}
</style>
</head>
<body>

<!-- ========== PERGAMINHO ========== -->
<div id="scroll-screen" aria-hidden="true">
  <div class="scroll-wrap" role="img" aria-label="Pergaminho abrindo">
    <div class="scroll-top" aria-hidden="true"></div>
    <div class="scroll-paper" aria-hidden="true">
      <div class="seal" aria-hidden="true"><div class="char">Â∞Å</div></div>
      <div class="title">MEU UNIVERSO X</div>
    </div>
    <div class="scroll-bottom" aria-hidden="true"></div>
  </div>
</div>

<!-- ========== LOGIN ========== -->
<div id="login-screen">
  <div class="login-card" role="dialog" aria-label="Painel de login">
    <h2>üîí Meu Universo X</h2>
    <p id="login-sub">Insere a senha para entrar ‚Äî ou define uma nova senha.</p>

    <input id="pwd" class="input" type="password" placeholder="Senha" autocomplete="off" />
    <button id="btnLogin" class="btn">Entrar</button>

    <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
      <button id="btnSetPwd" class="btn-ghost">Definir / Alterar senha</button>
      <button id="btnForgot" class="btn-ghost" title="Apaga os dados locais">Esqueci / Apagar dados</button>
    </div>

    <div class="err" id="errLogin">Senha incorreta</div>
  </div>
</div>

<!-- ========== APP ========== -->
<div id="app" aria-hidden="true">
  <div class="topbar">
    <div class="brand">
      <div class="logo">MX</div>
      <div>
        <div class="apptitle">Meu Universo X</div>
        <div style="font-size:12px;color:rgba(255,255,255,.45)">Shinobi Tech ‚Ä¢ Notas</div>
      </div>
    </div>
    <div class="top-actions">
      <input id="search" class="search" placeholder="Procurar notas..." />
      <button class="btn-ghost" id="openSettings">‚öôÔ∏è</button>
      <button class="btn-ghost" id="logoutBtn">üö™ Sair</button>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar" aria-label="Menu lateral">
      <div class="side-section">
        <div class="side-title">Notas</div>
        <div class="menu-item active" data-tab="all">Todas</div>
        <div class="menu-item" data-tab="fav">Favoritas</div>
        <div class="menu-item" data-tab="arch">Arquivadas</div>
      </div>

      <div class="side-section">
        <div class="side-title">Tags</div>
        <div class="menu-item" id="tag-todos">#todos</div>
      </div>

      <div style="flex:1"></div>
      <div style="font-size:12px;color:rgba(255,255,255,.45)">LocalStorage ‚Ä¢ Offline</div>
    </aside>

    <main class="main" id="main">
      <div class="controls">
        <button class="btn-ghost" id="newNote">+ Nova Nota</button>
        <div style="flex:1"></div>
        <div class="small">Notas: <span id="count">0</span></div>
      </div>

      <div class="grid" id="grid"></div>
    </main>
  </div>

  <div class="floating" id="fab">+</div>
</div>

<!-- ========== MODAL: editor ========== -->
<div class="modal" id="modal">
  <div class="modal-card" role="dialog" aria-label="Editor de nota">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">Editor de Nota</div>
      <div><button class="btn-ghost" id="closeModal">Fechar</button></div>
    </div>

    <input id="noteTitle" class="input" placeholder="T√≠tulo da nota" />
    <textarea id="noteContent" class="input" placeholder="Escreve a nota..."></textarea>

    <div class="note-meta">
      <button class="btn" id="saveNote">Salvar</button>
      <button class="btn-ghost" id="toggleFav">‚≠ê Favorita</button>
      <button class="btn-ghost" id="archiveNote">üì¶ Arquivar</button>
      <div style="flex:1"></div>
      <button class="btn-ghost" id="delNote" style="color:var(--danger)">Apagar</button>
    </div>
  </div>
</div>

<!-- ========== MODAL: settings ========== -->
<div class="modal" id="modal-settings">
  <div class="modal-card" role="dialog" aria-label="Configura√ß√µes">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">Configura√ß√µes & Backup</div>
      <div><button class="btn-ghost" id="closeSettings">Fechar</button></div>
    </div>

    <div style="margin-bottom:8px" class="small">Definir / Alterar senha (guardada no navegador)</div>
    <input id="newPwd" class="input" type="password" placeholder="Nova senha (deixa vazio para n√£o alterar)" />
    <input id="newPwdConfirm" class="input" type="password" placeholder="Confirmar nova senha" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="savePwd">Salvar senha</button>
      <button class="btn-ghost" id="clearAll" style="color:var(--danger)">Apagar tudo</button>
      <div style="flex:1"></div>
      <div class="small" id="pwdMsg"></div>
    </div>

    <hr style="margin:16px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn-ghost" id="exportData">Exportar JSON</button>
      <label class="btn-ghost" style="cursor:pointer">
        Importar JSON
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </label>
      <div style="flex:1"></div>
      <div class="small" id="importMsg"></div>
    </div>

  </div>
</div>

<!-- ====== SCRIPTS ====== -->
<script>
/*
  Vers√£o profissional: c√≥digo compacto, sem duplica√ß√µes, robusto.
  Funcionalidades:
  - Pergaminho de abertura
  - Definir/Alterar senha (localStorage)
  - Notas: criar/editar/apagar/favoritar/arquivar
  - Pesquisa
  - Export / Import JSON
  - Pronto para GitHub Pages
*/

/* ---------- constantes e estado ---------- */
const LS_KEY = 'mx_user_data_v2';
const defaultState = { password: null, notes: [] };
let state = loadState();

const els = {
  scrollScreen: document.getElementById('scroll-screen'),
  loginScreen: document.getElementById('login-screen'),
  app: document.getElementById('app'),
  pwdInput: document.getElementById('pwd'),
  btnLogin: document.getElementById('btnLogin'),
  btnSetPwd: document.getElementById('btnSetPwd'),
  btnForgot: document.getElementById('btnForgot'),
  loginSub: document.getElementById('login-sub'),
  errLogin: document.getElementById('errLogin'),
  openSettings: document.getElementById('openSettings'),
  logoutBtn: document.getElementById('logoutBtn'),
  search: document.getElementById('search'),
  grid: document.getElementById('grid'),
  count: document.getElementById('count'),
  newNoteBtn: document.getElementById('newNote'),
  fab: document.getElementById('fab'),
  modal: document.getElementById('modal'),
  noteTitle: document.getElementById('noteTitle'),
  noteContent: document.getElementById('noteContent'),
  saveNoteBtn: document.getElementById('saveNote'),
  closeModalBtn: document.getElementById('closeModal'),
  delNoteBtn: document.getElementById('delNote'),
  toggleFavBtn: document.getElementById('toggleFav'),
  archiveNoteBtn: document.getElementById('archiveNote'),
  modalSettings: document.getElementById('modal-settings'),
  closeSettingsBtn: document.getElementById('closeSettings'),
  newPwd: document.getElementById('newPwd'),
  newPwdConfirm: document.getElementById('newPwdConfirm'),
  savePwdBtn: document.getElementById('savePwd'),
  pwdMsg: document.getElementById('pwdMsg'),
  clearAllBtn: document.getElementById('clearAll'),
  exportDataBtn: document.getElementById('exportData'),
  importFileInput: document.getElementById('importFile'),
  importMsg: document.getElementById('importMsg'),
  menuItems: document.querySelectorAll('.menu-item'),
};

/* ---------- helpers: load/save ---------- */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    // sanity
    parsed.notes = Array.isArray(parsed.notes) ? parsed.notes : [];
    return parsed;
  }catch(e){
    console.error('loadState error', e);
    return structuredClone(defaultState);
  }
}
function saveState(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }catch(e){
    console.error('saveState', e);
  }
}

/* ---------- anima√ß√£o inicial -> login ---------- */
setTimeout(()=> {
  els.scrollScreen.classList.add('fade-out');
  setTimeout(()=> {
    els.scrollScreen.style.display = 'none';
    showLogin();
  }, 900);
}, 3400);

function showLogin(){
  els.loginScreen.style.display = 'flex';
  updateLoginSubtitle();
  els.pwdInput.focus();
}
function updateLoginSubtitle(){
  els.loginSub.textContent = state.password ? 'Insere a senha para entrar.' : 'Sem senha definida ‚Äî define uma agora nas configura√ß√µes.';
}

/* ---------- login / senha ---------- */
els.btnLogin.addEventListener('click', attemptLogin);
els.pwdInput.addEventListener('keypress', e => { if(e.key === 'Enter') attemptLogin(); });

function attemptLogin(){
  const value = els.pwdInput.value || '';
  if(!state.password){
    // for√ßa definir senha antes de entrar
    showSettings();
    showErr('Nenhuma senha definida. Define uma senha nas configura√ß√µes.', 1800);
    return;
  }
  if(value === state.password){
    // sucesso
    els.loginScreen.style.display = 'none';
    startApp();
    els.pwdInput.value = '';
  } else {
    showErr('Senha incorreta', 1400);
  }
}

els.btnSetPwd.addEventListener('click', showSettings);
els.openSettings.addEventListener('click', showSettings);

/* apagar tudo (esqueci) */
els.btnForgot.addEventListener('click', ()=>{
  if(confirm('Apagar todos os dados locais (inclui senha e notas)? Esta a√ß√£o n√£o pode ser desfeita.')){
    localStorage.removeItem(LS_KEY);
    state = structuredClone(defaultState);
    saveState();
    updateLoginSubtitle();
    showErr('Dados apagados. Define nova senha nas configura√ß√µes.', 1600);
  }
});

/* salvar nova senha */
els.savePwdBtn.addEventListener('click', ()=>{
  const a = els.newPwd.value;
  const b = els.newPwdConfirm.value;
  if(!a){ els.pwdMsg.textContent = 'Senha vazia ‚Äî nada alterado.'; els.pwdMsg.style.color = 'var(--danger)'; return; }
  if(a !== b){ els.pwdMsg.textContent = 'As senhas n√£o coincidem.'; els.pwdMsg.style.color = 'var(--danger)'; return; }
  state.password = a;
  saveState();
  els.pwdMsg.textContent = 'Senha salva.'; els.pwdMsg.style.color = 'lightgreen';
  setTimeout(()=> { els.pwdMsg.textContent=''; hideSettings(); updateLoginSubtitle(); }, 900);
});

/* apagar tudo nas configs */
els.clearAllBtn.addEventListener('click', ()=>{
  if(confirm('Apagar tudo (senha + notas)?')){
    localStorage.removeItem(LS_KEY);
    state = structuredClone(defaultState);
    saveState();
    els.importMsg.textContent = '';
    els.pwdMsg.textContent = 'Apagado.';
    setTimeout(()=> { els.pwdMsg.textContent=''; hideSettings(); updateLoginSubtitle(); }, 900);
  }
});

/* ---------- iniciar app ---------- */
function startApp(){
  els.app.style.display = 'block';
  renderNotes();
}

/* logout */
els.logoutBtn.addEventListener('click', ()=> {
  if(confirm('Deseja sair?')){ els.app.style.display='none'; els.loginScreen.style.display='flex'; }
});

/* ---------- notas CRUD ---------- */
let currentEditId = null;

els.newNoteBtn.addEventListener('click', ()=> openEditor(null));
els.fab.addEventListener('click', ()=> openEditor(null));
els.closeModalBtn.addEventListener('click', ()=> closeEditor());

els.saveNoteBtn.addEventListener('click', saveNote);
els.delNoteBtn.addEventListener('click', deleteNote);
els.toggleFavBtn.addEventListener('click', toggleFavCurrent);
els.archiveNoteBtn.addEventListener('click', toggleArchiveCurrent);

/* abrir editor (nova ou editar) */
function openEditor(id){
  currentEditId = id || null;
  if(id){
    const n = state.notes.find(x => x.id === id);
    if(n){ els.noteTitle.value = n.title; els.noteContent.value = n.content; }
  } else {
    els.noteTitle.value = '';
    els.noteContent.value = '';
  }
  els.modal.style.display = 'flex';
  els.noteTitle.focus();
}
function closeEditor(){
  els.modal.style.display = 'none';
  currentEditId = null;
}

/* salvar nota */
function saveNote(){
  const title = (els.noteTitle.value || '').trim();
  const content = (els.noteContent.value || '').trim();
  if(currentEditId){
    const idx = state.notes.findIndex(n => n.id === currentEditId);
    if(idx > -1){
      state.notes[idx].title = title;
      state.notes[idx].content = content;
      state.notes[idx].updated = Date.now();
    }
  } else {
    const note = { id: Date.now(), title, content, created: Date.now(), updated: Date.now(), fav: false, archived: false };
    state.notes.push(note);
  }
  saveState();
  closeEditor();
  renderNotes(getActiveTab(), els.search.value.trim());
}

/* apagar nota */
function deleteNote(){
  if(!currentEditId) return;
  if(!confirm('Apagar esta nota?')) return;
  state.notes = state.notes.filter(n => n.id !== currentEditId);
  saveState();
  closeEditor();
  renderNotes(getActiveTab(), els.search.value.trim());
}

/* favoritar / arquivar */
function toggleFavCurrent(){
  if(!currentEditId) return;
  const n = state.notes.find(x => x.id === currentEditId);
  if(n){ n.fav = !n.fav; saveState(); renderNotes(getActiveTab(), els.search.value.trim()); }
}
function toggleArchiveCurrent(){
  if(!currentEditId) return;
  const n = state.notes.find(x => x.id === currentEditId);
  if(n){ n.archived = !n.archived; saveState(); renderNotes(getActiveTab(), els.search.value.trim()); }
}

/* abrir nota ao clicar na lista */
function openNoteById(id){
  currentEditId = id;
  const n = state.notes.find(x => x.id === id);
  if(n){
    els.noteTitle.value = n.title;
    els.noteContent.value = n.content;
    els.modal.style.display = 'flex';
  }
}

/* renderiza√ß√£o */
function renderNotes(filter='all', query=''){
  els.grid.innerHTML = '';
  const notes = Array.isArray(state.notes) ? state.notes : [];
  let visible = notes.slice().reverse(); // newest first

  if(filter === 'fav') visible = visible.filter(n => n.fav && !n.archived);
  else if(filter === 'arch') visible = visible.filter(n => n.archived);
  else visible = visible.filter(n => !n.archived);

  if(query) visible = visible.filter(n => (n.title + ' ' + n.content).toLowerCase().includes(query.toLowerCase()));

  visible.forEach(n => {
    const el = document.createElement('div');
    el.className = 'note';
    // small preview
    el.innerHTML = `
      <h4>${escapeHtml(n.title || 'Sem t√≠tulo')}</h4>
      <p>${escapeHtml(n.content || '')}</p>
      <div class="meta"><span>${new Date(n.created).toLocaleString()}</span><span>${n.fav? '‚≠ê':''}${n.archived? ' ‚Ä¢ arquivada':''}</span></div>
    `;
    el.addEventListener('click', ()=> openNoteById(n.id));
    els.grid.appendChild(el);
  });

  els.count.textContent = notes.length;
}

/* escape b√°sico */
function escapeHtml(s = '') { 
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

/* ---------- pesquisa ---------- */
els.search.addEventListener('input', e => renderNotes(getActiveTab(), e.target.value.trim()));

/* ---------- sidebar nav ---------- */
els.menuItems.forEach(mi => {
  mi.addEventListener('click', ()=>{
    els.menuItems.forEach(x => x.classList.remove('active'));
    mi.classList.add('active');
    renderNotes(getActiveTab(), els.search.value.trim());
  });
});
function getActiveTab(){
  const active = document.querySelector('.menu-item.active');
  if(!active) return 'all';
  return active.dataset.tab || 'all';
}

/* ---------- settings modal open/close ---------- */
function showSettings(){ els.modalSettings.style.display = 'flex'; els.newPwd.value = ''; els.newPwdConfirm.value = ''; els.pwdMsg.textContent = ''; els.importMsg.textContent = ''; }
function hideSettings(){ els.modalSettings.style.display = 'none'; }
els.closeSettingsBtn.addEventListener('click', hideSettings);

/* fechar modals clicando fora */
[els.modal, els.modalSettings].forEach(m => {
  m.addEventListener('click', e => {
    if(e.target === m) m.style.display = 'none';
  });
});

/* ---------- export / import JSON ---------- */
els.exportDataBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'meu_universo_x_export.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

els.importFileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const parsed = JSON.parse(reader.result);
      if(!parsed || typeof parsed !== 'object') throw new Error('JSON inv√°lido');
      // basic validation
      parsed.notes = Array.isArray(parsed.notes) ? parsed.notes : [];
      parsed.password = parsed.password || null;
      if(!confirm('Importar ir√° substituir os dados locais. Continuar?')) return;
      state = parsed;
      saveState();
      els.importMsg.textContent = 'Importado.';
      setTimeout(()=> els.importMsg.textContent = '', 1200);
      hideSettings();
      // se j√° estiver logado, atualiza vista
      if(els.app.style.display === 'block') renderNotes(getActiveTab(), els.search.value.trim());
      else updateLoginSubtitle();
    }catch(err){
      els.importMsg.textContent = 'Erro ao importar: JSON inv√°lido';
      setTimeout(()=> els.importMsg.textContent = '', 1800);
    }
  };
  reader.readAsText(f);
  // limpa input
  e.target.value = '';
});

/* ---------- utilidades pequenas ---------- */
function showErr(msg, ms = 1400){
  els.errLogin.textContent = msg;
  els.errLogin.style.display = 'block';
  setTimeout(()=> els.errLogin.style.display = 'none', ms);
}

/* inicial render se j√° estava logado (modo dev) */
if(location.hash === '#dev-autologin' && state.password){
  els.loginScreen.style.display = 'none';
  startApp();
}

/* fim do script */
</script>
</body>
</html>
