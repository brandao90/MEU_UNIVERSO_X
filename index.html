<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meu Universo X ‚Äî Shinobi Tech PRO</title>
<style>
:root{
  --bg:#071022;
  --panel:#071026;
  --accent:#00d4ff;
  --muted:rgba(255,255,255,0.08);
  --danger:#ff6b6b;
  --glass:rgba(255,255,255,0.03);
}

/* reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:#fff;font-family:Inter,Arial,system-ui;overflow:hidden}

/* ----------------- PERGAMINHO CINEM√ÅTICO ----------------- */
#scroll-screen{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(circle at 30% 20%, #062033 0%, #030612 65%);
  z-index:99999;overflow:hidden;
}

/* core drop then unroll */
.scroll-core{width:92%;max-width:820px;transform-origin:top;opacity:0;animation:dropIn .7s ease-out forwards}
@keyframes dropIn{0%{transform:translateY(-220px) scaleY(.3);opacity:0}70%{opacity:1}100%{transform:translateY(0) scaleY(1)}}

/* top & bottom wooden rods */
.scroll-top,.scroll-bottom{height:56px;background:linear-gradient(90deg,#5c3412,#b5783f,#5c3412);border-radius:36px;box-shadow:0 18px 50px rgba(0,0,0,.6)}

/* paper body that unrolls */
.scroll-body{
  background:linear-gradient(180deg,#f6e9cf,#e8d5aa);
  min-height:360px;padding:96px 48px;box-shadow:inset 0 0 80px rgba(0,0,0,.18);
  transform-origin:top;transform:scaleY(0);
  animation:unroll 2.2s cubic-bezier(.15,.95,.25,1.15) .25s forwards;
}
@keyframes unroll{0%{transform:scaleY(0)}60%{transform:scaleY(1.12)}100%{transform:scaleY(1)}}

/* smoke using CSS radial-gradients + SVG filter for organic look */
.scroll-smoke{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.6);width:900px;height:520px;
  pointer-events:none;opacity:0;filter:blur(8px) url(#goo);
  background:
    radial-gradient(closest-side at 20% 20%, rgba(0,200,255,0.12) 0%, transparent 30%),
    radial-gradient(closest-side at 80% 40%, rgba(0,200,255,0.08) 0%, transparent 28%),
    radial-gradient(closest-side at 50% 70%, rgba(255,255,255,0.03) 0%, transparent 35%),
    radial-gradient(closest-side at 35% 50%, rgba(0,0,0,0.04) 0%, transparent 40%);
  animation:smokeIn 1.6s ease-out .6s forwards;
  mix-blend-mode:screen;
}
@keyframes smokeIn{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}50%{opacity:.9}100%{opacity:0;transform:translate(-50%,-50%) scale(1.15)}}

/* seal pop */
.scroll-seal{width:128px;height:128px;border-radius:50%;margin:0 auto 18px;
  background:radial-gradient(circle,#de3b3b 0%,#7e0000 100%);display:flex;align-items:center;justify-content:center;
  opacity:0;transform:scale(.2);animation:sealPop .7s cubic-bezier(.2,1.4,.3,1) 1.1s forwards;box-shadow:0 14px 40px rgba(217,59,59,.24)}
.scroll-seal-char{font-size:52px;font-weight:900;color:white;text-shadow:0 4px 12px rgba(0,0,0,.6)}

/* title reveal */
.scroll-title{font-family:Georgia,serif;font-size:48px;color:#7a4317;text-align:center;opacity:0;transform:translateY(20px);animation:titleIn 1s ease-out 1.6s forwards}
@keyframes titleIn{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}

/* close animation */
.fade-out-scroll{animation:scrollClose 1.1s ease forwards}
@keyframes scrollClose{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-120px) scale(.6)}}

/* ---------------------------------------------------------------- */
/* ----------------- LOGIN CARD & APP BASE ------------------------- */
/* ---------------------------------------------------------------- */

#login-screen{display:none;height:100vh;align-items:center;justify-content:center;padding:20px}
.login-card{width:100%;max-width:480px;padding:28px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid var(--muted);backdrop-filter:blur(8px);box-shadow:0 30px 80px rgba(0,0,0,.6);text-align:center}
.login-card h2{color:var(--accent);margin-bottom:8px}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;margin:10px 0;outline:none}
.btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#0099cc);color:#021;cursor:pointer;font-weight:700}
.row-opts{display:flex;gap:8px;justify-content:center;margin-top:12px}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
.err{color:var(--danger);display:none;margin-top:8px}

/* app layout */
#app{display:none;height:100vh;overflow:hidden}
.topbar{height:72px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:linear-gradient(90deg,rgba(0,0,0,0.12),transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
.brand{display:flex;align-items:center;gap:14px}
.logo{width:46px;height:46;border-radius:10px;background:linear-gradient(135deg,#021428,#002b42);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent);box-shadow:0 8px 28px rgba(0,212,255,0.05)}
.apptitle{font-size:18px;color:var(--accent);font-weight:700}
.top-actions{display:flex;gap:10px;align-items:center}
.search{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}

/* main layout */
.container{display:flex;height:calc(100vh - 72px);overflow:hidden}
.sidebar{width:270px;padding:22px;background:linear-gradient(180deg,rgba(0,0,0,0.08),transparent);border-right:1px solid rgba(255,255,255,0.02)}
.side-title{font-size:12px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.menu-item{padding:10px 12px;border-radius:8px;color:rgba(255,255,255,.85);cursor:pointer;margin-bottom:8px}
.menu-item.active{background:linear-gradient(90deg,rgba(0,212,255,0.06),transparent);color:var(--accent);font-weight:700}
.main{flex:1;padding:20px;overflow:auto;background:linear-gradient(180deg,#071026 0%, #041122 100%)}
.controls{display:flex;gap:12px;align-items:center;margin-bottom:18px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.note{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;min-height:110px;display:flex;flex-direction:column;gap:8px}
.note h4{margin:0;font-size:15px;color:var(--accent)}
.note p{margin:0;color:rgba(255,255,255,.78);font-size:13px;white-space:pre-wrap;flex:1}
.note .meta{display:flex;justify-content:space-between;color:rgba(255,255,255,.45);font-size:12px}

/* floating action */
.fab{position:fixed;right:28px;bottom:28px;width:64px;height:64px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#0099cc);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021;box-shadow:0 18px 60px rgba(0,212,255,0.12);cursor:pointer}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.6));z-index:1200}
.modal-card{width:100%;max-width:760px;background:linear-gradient(180deg,#071026,#081430);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.input.mono{font-family:monospace}

.small{font-size:13px;color:rgba(255,255,255,.7)}
.btn-small{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#021;cursor:pointer}

/* responsive */
@media(max-width:860px){
  .sidebar{display:none}
  .grid{grid-template-columns:1fr}
}
</style>

<!-- SVG filter for "goo" / organic smoke -->
<svg width="0" height="0" style="position:absolute">
  <filter id="goo">
    <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur"/>
    <feColorMatrix in="blur" type="matrix"
      values="1 0 0 0 0
              0 1 0 0 0
              0 0 1 0 0
              0 0 0 18 -7" result="goo" />
    <feBlend in="SourceGraphic" in2="goo"/>
  </filter>
</svg>
</head>
<body>

<!-- ===== PERGAMINHO ===== -->
<div id="scroll-screen" aria-hidden="true">
  <div class="scroll-smoke" aria-hidden="true"></div>

  <div class="scroll-core" role="img" aria-label="Pergaminho abrindo">
    <div class="scroll-top" aria-hidden="true"></div>

    <div class="scroll-body">
      <div class="scroll-seal"><div class="scroll-seal-char">Â∞Å</div></div>
      <div class="scroll-title">MEU UNIVERSO X</div>
    </div>

    <div class="scroll-bottom" aria-hidden="true"></div>
  </div>
</div>

<!-- ===== LOGIN ===== -->
<div id="login-screen" aria-hidden="true">
  <div class="login-card" role="dialog" aria-label="Painel de login">
    <h2>üîí Meu Universo X</h2>
    <p id="login-sub" class="small">Insere a senha para entrar ‚Äî ou define uma nova senha.</p>
    <input id="pwd" class="input" type="password" placeholder="Senha" autocomplete="off" />
    <button id="btnLogin" class="btn">Entrar</button>

    <div class="row-opts">
      <button id="btnSetPwd" class="btn-ghost">Definir / Alterar senha</button>
      <button id="btnForgot" class="btn-ghost">Esqueci / Apagar dados</button>
    </div>

    <div id="errLogin" class="err">Senha incorreta</div>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app" aria-hidden="true">
  <div class="topbar">
    <div class="brand">
      <div class="logo">MX</div>
      <div><div class="apptitle">Meu Universo X</div><div class="small">Shinobi Tech ‚Ä¢ Notas</div></div>
    </div>

    <div class="top-actions">
      <input id="search" class="search" placeholder="Procurar notas..." />
      <button id="openSettings" class="btn-ghost">‚öôÔ∏è</button>
      <button id="logoutBtn" class="btn-ghost">üö™ Sair</button>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar" aria-label="Menu lateral">
      <div class="side-title">Notas</div>
      <div class="menu-item active" data-tab="all">Todas</div>
      <div class="menu-item" data-tab="fav">Favoritas</div>
      <div class="menu-item" data-tab="arch">Arquivadas</div>

      <div style="height:20px"></div>
      <div class="side-title">Partilha</div>
      <div class="small">Partilha texto de notas por WhatsApp ‚Ä¢ Telegram ‚Ä¢ X ‚Ä¢ Email ‚Ä¢ Copiar</div>
      <div style="flex:1"></div>
      <div class="small">LocalStorage ‚Ä¢ Offline</div>
    </aside>

    <main class="main" id="main">
      <div class="controls">
        <button id="newNote" class="btn-ghost">+ Nova Nota</button>
        <div style="flex:1"></div>
        <div class="small">Notas: <span id="count">0</span></div>
      </div>

      <div class="grid" id="grid"></div>
    </main>
  </div>

  <div class="fab" id="fab">+</div>
</div>
<!-- ===== MODAIS ===== -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-label="Editor de Nota">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">Editor de Nota</div>
      <div><button id="closeModal" class="btn-ghost">Fechar</button></div>
    </div>

    <input id="noteTitle" class="input" placeholder="T√≠tulo da nota" />
    <textarea id="noteContent" class="input mono" placeholder="Escreve a nota..." style="min-height:160px"></textarea>

    <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
      <button id="saveNote" class="btn">Salvar</button>
      <button id="toggleFav" class="btn-ghost">‚≠ê Favorita</button>
      <button id="archiveNote" class="btn-ghost">üì¶ Arquivar</button>
      <button id="delNote" class="btn-ghost" style="color:var(--danger)">Apagar</button>

      <div style="flex:1"></div>

      <!-- Partilha -->
      <div style="display:flex;gap:8px">
        <button id="shareWhatsapp" class="btn-ghost">WhatsApp</button>
        <button id="shareTelegram" class="btn-ghost">Telegram</button>
        <button id="shareX" class="btn-ghost">X</button>
        <button id="shareEmail" class="btn-ghost">Email</button>
        <button id="copyText" class="btn-ghost">Copiar</button>
      </div>
    </div>
  </div>
</div>

<div id="modal-settings" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-label="Configura√ß√µes">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">Configura√ß√µes & Backup</div>
      <div><button id="closeSettings" class="btn-ghost">Fechar</button></div>
    </div>

    <div class="small">Definir / Alterar senha (guardada no navegador)</div>
    <input id="newPwd" class="input" type="password" placeholder="Nova senha" />
    <input id="newPwdConfirm" class="input" type="password" placeholder="Confirmar nova senha" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="savePwd" class="btn">Salvar senha</button>
      <button id="clearAll" class="btn-ghost" style="color:var(--danger)">Apagar tudo</button>
      <div style="flex:1"></div>
      <div id="pwdMsg" class="small"></div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

    <div style="display:flex;gap:8px;align-items:center">
      <button id="exportData" class="btn-ghost">Exportar JSON</button>
      <label class="btn-ghost" style="cursor:pointer">Importar JSON
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </label>
      <div style="flex:1"></div>
      <div id="importMsg" class="small"></div>
    </div>
  </div>
</div>

<script>
/* ---------- Estado e armazenamento ---------- */
const LS_KEY = 'mx_user_data_pro_v1';
let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {password:null,notes:[]};
    const parsed = JSON.parse(raw);
    parsed.notes = Array.isArray(parsed.notes) ? parsed.notes : [];
    return parsed;
  }catch(e){ console.error('load error',e); return {password:null,notes:[]} }
}
function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){console.error(e)} }

/* ---------- UI refs ---------- */
const refs = {
  scroll: document.getElementById('scroll-screen'),
  smoke: document.querySelector('.scroll-smoke'),
  loginScreen: document.getElementById('login-screen'),
  app: document.getElementById('app'),
  pwd: document.getElementById('pwd'),
  btnLogin: document.getElementById('btnLogin'),
  btnSetPwd: document.getElementById('btnSetPwd'),
  btnForgot: document.getElementById('btnForgot'),
  errLogin: document.getElementById('errLogin'),
  loginSub: document.getElementById('login-sub'),
  newNote: document.getElementById('newNote'),
  fab: document.getElementById('fab'),
  grid: document.getElementById('grid'),
  count: document.getElementById('count'),
  search: document.getElementById('search'),
  modal: document.getElementById('modal'),
  noteTitle: document.getElementById('noteTitle'),
  noteContent: document.getElementById('noteContent'),
  saveNote: document.getElementById('saveNote'),
  closeModal: document.getElementById('closeModal'),
  delNote: document.getElementById('delNote'),
  toggleFav: document.getElementById('toggleFav'),
  archiveNote: document.getElementById('archiveNote'),
  menuItems: document.querySelectorAll('.menu-item'),
  openSettings: document.getElementById('openSettings'),
  modalSettings: document.getElementById('modal-settings'),
  closeSettings: document.getElementById('closeSettings'),
  newPwd: document.getElementById('newPwd'),
  newPwdConfirm: document.getElementById('newPwdConfirm'),
  savePwd: document.getElementById('savePwd'),
  clearAll: document.getElementById('clearAll'),
  pwdMsg: document.getElementById('pwdMsg'),
  exportData: document.getElementById('exportData'),
  importFile: document.getElementById('importFile'),
  importMsg: document.getElementById('importMsg'),
  shareWhatsapp: document.getElementById('shareWhatsapp'),
  shareTelegram: document.getElementById('shareTelegram'),
  shareX: document.getElementById('shareX'),
  shareEmail: document.getElementById('shareEmail'),
  copyText: document.getElementById('copyText'),
};

/* ---------- ANIMA√á√ÉO: pergaminho -> mostrar login ---------- */
/* dropIn + unroll j√° executam via CSS. Aqui controlamos o encerramento e som/fuma√ßa */
setTimeout(()=> {
  // after title showed, play jutsu sound, smoke, then close scroll
  playJutsuTone();
  refs.smoke.style.opacity = '1';
  // close after delay
  setTimeout(()=> {
    document.querySelector('.scroll-core').classList.add('fade-out-scroll');
    setTimeout(()=> {
      refs.scroll.style.display = 'none';
      showLogin();
    }, 1100);
  }, 1500);
}, 2800);

/* ---------- WebAudio: simple jutsu tone (no files) ---------- */
function playJutsuTone(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 220;
    g.gain.value = 0;
    o.connect(g);
    g.connect(ctx.destination);
    // envelope
    const now = ctx.currentTime;
    g.gain.cancelScheduledValues(now);
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.18, now + 0.02);
    o.frequency.setValueAtTime(220, now);
    o.frequency.exponentialRampToValueAtTime(880, now + 0.28);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 1.4);
    o.start(now);
    o.stop(now + 1.5);
  }catch(e){ /*ignore on unsupported*/ }
}

/* ---------- Login & senha ---------- */
function showLogin(){
  refs.loginScreen.style.display = 'flex';
  updateLoginSubtitle();
  refs.pwd.focus();
}
function updateLoginSubtitle(){
  refs.loginSub.textContent = state.password ? 'Insere a senha para entrar.' : 'Sem senha definida ‚Äî define uma agora.';
}
refs.btnLogin.addEventListener('click', attemptLogin);
refs.pwd.addEventListener('keypress', (e)=> { if(e.key === 'Enter') attemptLogin(); });

function attemptLogin(){
  const val = refs.pwd.value || '';
  if(!state.password){
    showSettings();
    showError('Nenhuma senha definida. Define uma nas configura√ß√µes.', 1600);
    return;
  }
  if(val === state.password){
    refs.loginScreen.style.display = 'none';
    startApp();
    refs.pwd.value = '';
  } else {
    showError('Senha incorreta', 1400);
  }
}

refs.btnSetPwd.addEventListener('click', showSettings);
refs.openSettings.addEventListener('click', showSettings);
refs.btnForgot.addEventListener('click', ()=> {
  if(confirm('Apagar todos os dados locais (inclui senha e notas)? Isto n√£o pode ser desfeito.')){
    localStorage.removeItem(LS_KEY);
    state = {password:null,notes:[]};
    saveState();
    updateLoginSubtitle();
    showError('Dados apagados. Define nova senha.', 1400);
  }
});

/* salvar senha */
refs.savePwd.addEventListener('click', ()=> {
  const a = refs.newPwd.value;
  const b = refs.newPwdConfirm.value;
  if(!a){ refs.pwdMsg.textContent = 'Senha vazia'; refs.pwdMsg.style.color = 'var(--danger)'; return; }
  if(a !== b){ refs.pwdMsg.textContent = 'Senhas n√£o coincidem'; refs.pwdMsg.style.color = 'var(--danger)'; return; }
  state.password = a;
  saveState();
  refs.pwdMsg.textContent = 'Senha salva'; refs.pwdMsg.style.color = 'lightgreen';
  setTimeout(()=> { refs.pwdMsg.textContent=''; hideSettings(); updateLoginSubtitle(); }, 900);
});

/* limpar tudo nas configura√ß√µes */
refs.clearAll.addEventListener('click', ()=> {
  if(confirm('Apagar tudo (senha + notas)?')){
    localStorage.removeItem(LS_KEY);
    state = {password:null,notes:[]};
    saveState();
    refs.importMsg.textContent = '';
    refs.pwdMsg.textContent = 'Apagado';
    setTimeout(()=> { refs.pwdMsg.textContent=''; hideSettings(); updateLoginSubtitle(); },900);
  }
});

/* show/hide settings */
function showSettings(){ refs.modalSettings.style.display='flex'; refs.newPwd.value=''; refs.newPwdConfirm.value=''; refs.pwdMsg.textContent=''; refs.importMsg.textContent=''; }
function hideSettings(){ refs.modalSettings.style.display='none'; }
refs.closeSettings.addEventListener('click', hideSettings);

/* ---------- APP flow ---------- */
function startApp(){
  refs.app.style.display = 'block';
  renderNotes();
}

/* logout */
document.getElementById('logoutBtn').addEventListener('click', ()=> {
  if(confirm('Deseja sair?')){ refs.app.style.display='none'; refs.loginScreen.style.display='flex'; }
});

/* ---------- Notas CRUD ---------- */
let currentEditId = null;

refs.newNote.addEventListener('click', ()=> openEditor(null));
refs.fab.addEventListener('click', ()=> openEditor(null));
refs.closeModal.addEventListener('click', ()=> closeEditor());
refs.saveNote.addEventListener('click', ()=> saveNote());
refs.delNote.addEventListener('click', ()=> deleteNote());
refs.toggleFav.addEventListener('click', ()=> toggleFav());
refs.archiveNote.addEventListener('click', ()=> toggleArchive());

function openEditor(id){
  currentEditId = id || null;
  if(id){
    const n = state.notes.find(x=>x.id===id);
    if(n){ refs.noteTitle.value = n.title; refs.noteContent.value = n.content; }
  } else { refs.noteTitle.value=''; refs.noteContent.value=''; }
  refs.modal.style.display='flex';
  refs.noteTitle.focus();
}
function closeEditor(){ refs.modal.style.display='none'; currentEditId = null; }

function saveNote(){
  const title = (refs.noteTitle.value || '').trim();
  const content = (refs.noteContent.value || '').trim();
  if(currentEditId){
    const idx = state.notes.findIndex(n=>n.id===currentEditId);
    if(idx > -1){ state.notes[idx].title = title; state.notes[idx].content = content; state.notes[idx].updated = Date.now(); }
  } else {
    const note = { id: Date.now(), title, content, created: Date.now(), updated: Date.now(), fav:false, archived:false };
    state.notes.push(note);
  }
  saveState();
  closeEditor();
  renderNotes(getActiveTab(), refs.search.value.trim());
}

function deleteNote(){
  if(!currentEditId) return;
  if(!confirm('Apagar esta nota?')) return;
  state.notes = state.notes.filter(n=>n.id !== currentEditId);
  saveState();
  closeEditor();
  renderNotes(getActiveTab(), refs.search.value.trim());
}

function toggleFav(){
  if(!currentEditId) return;
  const n = state.notes.find(x=>x.id===currentEditId);
  if(n){ n.fav = !n.fav; saveState(); renderNotes(getActiveTab(), refs.search.value.trim()); }
}

function toggleArchive(){
  if(!currentEditId) return;
  const n = state.notes.find(x=>x.id===currentEditId);
  if(n){ n.archived = !n.archived; saveState(); renderNotes(getActiveTab(), refs.search.value.trim()); }
}

function openNoteById(id){
  currentEditId = id;
  const n = state.notes.find(x=>x.id===id);
  if(n){ refs.noteTitle.value = n.title; refs.noteContent.value = n.content; refs.modal.style.display='flex' }
}

/* render */
function renderNotes(filter='all', query=''){
  refs.grid.innerHTML = '';
  const notes = Array.isArray(state.notes) ? state.notes : [];
  let visible = notes.slice().reverse();
  if(filter === 'fav') visible = visible.filter(n=>n.fav && !n.archived);
  else if(filter === 'arch') visible = visible.filter(n=>n.archived);
  else visible = visible.filter(n=>!n.archived);
  if(query) visible = visible.filter(n => (n.title + ' ' + n.content).toLowerCase().includes(query.toLowerCase()));
  visible.forEach(n=>{
    const card = document.createElement('div');
    card.className = 'note';
    card.innerHTML = `<h4>${escapeHtml(n.title || 'Sem t√≠tulo')}</h4><p>${escapeHtml(n.content || '')}</p>
      <div class="meta"><span>${new Date(n.created).toLocaleString()}</span><span>${n.fav? '‚≠ê':''}${n.archived? ' ‚Ä¢ arquivada':''}</span></div>`;
    card.addEventListener('click', ()=> openNoteById(n.id));
    refs.grid.appendChild(card);
  });
  refs.count.textContent = notes.length;
}

function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

/* ---------- search & tabs ---------- */
refs.search.addEventListener('input', e => renderNotes(getActiveTab(), e.target.value.trim()));
refs.menuItems.forEach(mi => mi.addEventListener('click', ()=> { refs.menuItems.forEach(x=>x.classList.remove('active')); mi.classList.add('active'); renderNotes(getActiveTab(), refs.search.value.trim()); }));
function getActiveTab(){ const a = document.querySelector('.menu-item.active'); return (a && a.dataset.tab) ? a.dataset.tab : 'all'; }

/* ---------- export/import ---------- */
refs.exportData.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'meu_universo_x_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
refs.importFile.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const parsed = JSON.parse(r.result);
      parsed.notes = Array.isArray(parsed.notes) ? parsed.notes : [];
      if(!confirm('Importar substituir√° dados locais. Continuar?')) return;
      state = parsed; saveState();
      refs.importMsg.textContent = 'Importado.'; setTimeout(()=> refs.importMsg.textContent = '',1200);
      hideSettings(); if(refs.app.style.display === 'block') renderNotes(getActiveTab(), refs.search.value.trim()); else updateLoginSubtitle();
    }catch(err){ refs.importMsg.textContent = 'JSON inv√°lido'; setTimeout(()=> refs.importMsg.textContent = '',1600); }
  };
  r.readAsText(f); e.target.value = '';
});

/* ---------- sharing (WhatsApp / Telegram / X / Email / Copy) ---------- */
function getShareText(){
  return (refs.noteTitle.value ? (refs.noteTitle.value + '\n\n') : '') + (refs.noteContent.value || '');
}
refs.shareWhatsapp.addEventListener('click', ()=> {
  const text = encodeURIComponent(getShareText());
  const url = `https://api.whatsapp.com/send?text=${text}`;
  window.open(url, '_blank');
});
refs.shareTelegram.addEventListener('click', ()=> {
  const text = encodeURIComponent(getShareText());
  const url = `https://t.me/share/url?url=&text=${text}`;
  window.open(url, '_blank');
});
refs.shareX.addEventListener('click', ()=> {
  const text = encodeURIComponent(getShareText());
  const url = `https://twitter.com/intent/tweet?text=${text}`;
  window.open(url, '_blank');
});
refs.shareEmail.addEventListener('click', ()=> {
  const subject = encodeURIComponent(refs.noteTitle.value || 'Nota');
  const body = encodeURIComponent(getShareText());
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
});
refs.copyText.addEventListener('click', async ()=> {
  try{
    await navigator.clipboard.writeText(getShareText());
    alert('Texto copiado para a √°rea de transfer√™ncia.');
  }catch(e){ alert('N√£o foi poss√≠vel copiar.'); }
});

/* ---------- small helpers ---------- */
function showError(msg, ms=1400){ refs.errLogin.textContent = msg; refs.errLogin.style.display = 'block'; setTimeout(()=> refs.errLogin.style.display='none', ms); }

/* close modals when clicking outside */
[refs.modal, refs.modalSettings].forEach(m => m.addEventListener('click', e => { if(e.target === m) m.style.display = 'none'; }));

/* initial dev mode auto-login if #dev-autologin */
if(location.hash === '#dev-autologin' && state.password){ refs.loginScreen.style.display='none'; startApp(); }

/* initial render if any notes exist (but only after login) */
renderNotes(getActiveTab(), refs.search.value.trim());

/* ensure UI reacts when importing/setting pwd */
function updateLoginSubtitle(){ document.getElementById('login-sub').textContent = state.password ? 'Insere a senha para entrar.' : 'Sem senha definida ‚Äî define uma agora.'; }

/* save state periodically to avoid race */
setInterval(saveState, 3000);
</script>

</body>
</html>
